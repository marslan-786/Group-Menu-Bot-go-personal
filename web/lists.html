<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WhatsApp Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        :root {
            --bg-dark: #0b141a;
            --bg-panel: #111b21;
            --primary: #00a884;
            --bubble-sent: #005c4b;
            --bubble-rec: #202c33;
            --text-main: #e9edef;
            --text-muted: #8696a0;
            --border: #222d34;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #374045; border-radius: 3px; }

        /* HOME */
        #home-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .session-card { background: var(--bg-panel); width: 100%; max-width: 350px; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; cursor: pointer; border: 1px solid var(--border); }

        /* APP */
        #app-view { display: none; width: 100%; height: 100%; position: relative; }
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-panel); border-right: 1px solid var(--border); }
        .app-header { height: 60px; background: var(--bg-panel); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid var(--border); }
        .tabs { display: flex; background: var(--bg-panel); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: var(--text-muted); border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .chat-item { display: flex; padding: 12px 15px; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #2a3942; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #6a7f8a; object-fit: cover; flex-shrink: 0; }

        /* CHAT WINDOW */
        #chat-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; z-index: 50; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .chat-nav { height: 60px; background: var(--bg-panel); display: flex; align-items: center; padding: 0 10px; gap: 10px; border-bottom: 1px solid var(--border); }
        
        .messages-area { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 6px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            opacity: 0.95; padding-bottom: 50px; 
        }

        /* --- BUBBLES --- */
        .msg { max-width: 80%; padding: 6px 8px; border-radius: 8px; font-size: 14.5px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); color: #e9edef; line-height: 1.4; word-wrap: break-word; display: flex; flex-direction: column; }
        .msg.sent { align-self: flex-end; background: var(--bubble-sent); border-top-right-radius: 0; }
        .msg.rec { align-self: flex-start; background: var(--bubble-rec); border-top-left-radius: 0; }
        
        .msg.sticker { background: transparent !important; box-shadow: none !important; padding: 0; align-self: inherit; }
        .msg.sticker.sent { align-self: flex-end; }
        .msg.sticker.rec { align-self: flex-start; }

        .sender-name { font-size: 12px; color: #f2c94c; font-weight: bold; margin-bottom: 2px; }
        .time { font-size: 10px; color: rgba(255,255,255,0.6); align-self: flex-end; margin-top: 4px; }

        /* --- REPLY CONTEXT --- */
        .reply-box {
            background: rgba(0,0,0,0.15); border-left: 4px solid var(--primary); 
            border-radius: 4px; padding: 4px 8px; margin-bottom: 6px; font-size: 12px;
            display: flex; flex-direction: column; cursor: pointer;
        }
        .reply-sender { color: var(--primary); font-weight: bold; font-size: 11px; margin-bottom: 2px; }
        .reply-text { color: rgba(255,255,255,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- AUDIO PLAYER (FIXED) --- */
        .wa-audio-player {
            display: flex; align-items: center; gap: 10px; 
            width: 230px; /* Fixed width to prevent overflow */
            height: 45px;
            background: rgba(0,0,0,0.1); border-radius: 8px; padding: 0 8px;
        }
        .control-btn {
            width: 35px; height: 35px; border-radius: 50%; background: #6a7f8a; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .audio-info { flex: 1; overflow: hidden; }
        .progress-bar { width: 100%; height: 3px; background: rgba(255,255,255,0.3); margin-top: 5px; border-radius: 2px; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        .spinner.show { display: block; }
        .icon { display: none; font-size: 16px; color: white; }
        .icon.show { display: block; }

        /* --- MEDIA --- */
        img.chat-img { max-width: 100%; border-radius: 6px; cursor: pointer; display: block; }
        img.sticker-img { width: 140px; height: auto; object-fit: contain; }

        /* FOOTER */
        .secure-footer {
            text-align: center; font-size: 10px; color: var(--text-muted); 
            background: rgba(11, 20, 26, 0.9); padding: 15px; 
            margin-top: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: center; gap: 5px;
            width: fit-content; align-self: center; margin-bottom: 20px;
        }

        /* LIGHTBOX */
        #lightbox { display: none; position: fixed; inset: 0; background: black; z-index: 100; align-items: center; justify-content: center; }
        #lightbox img { max-width: 100%; max-height: 100%; }
        .lb-close { position: absolute; top: 20px; left: 20px; color: white; font-size: 30px; cursor: pointer; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="home-view">
        <h2 style="color:var(--primary); margin-top:50px;">WHATSAPP VIP</h2>
        <div id="session-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <div id="app-view">
        <div class="sidebar">
            <div class="app-header">
                <span style="font-weight:bold; font-size:20px; color:#8696a0;">WhatsApp</span>
                <button onclick="location.reload()" style="background:none; border:none; color:#f15c6d;">EXIT</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chats')">Chats</button>
                <button class="tab-btn" onclick="switchTab('groups')">Groups</button>
                </div>
            <div class="chat-list" id="chat-list-box"></div>
        </div>

        <div id="chat-window">
            <div class="chat-nav">
                <button onclick="closeChat()" style="font-size:24px; background:none; border:none; color:white;">‚Üê</button>
                <img id="header-avatar" class="avatar" src="">
                <span id="header-name" style="font-weight:bold; font-size:16px; margin-left:10px;">User</span>
            </div>
            <div class="messages-area" id="msg-box"></div>
        </div>
    </div>

    <div id="lightbox">
        <div class="lb-close" onclick="document.getElementById('lightbox').style.display='none'">√ó</div>
        <img id="lb-img" src="">
    </div>

    <script>
        // --- DB ---
        const dbName="WA_Pro_DB"; let db;
        const req=indexedDB.open(dbName,1);
        req.onupgradeneeded=e=>{db=e.target.result;db.createObjectStore("media",{keyPath:"id"});};
        req.onsuccess=e=>{db=e.target.result;};
        function saveLocal(id,c){if(db)db.transaction(["media"],"readwrite").objectStore("media").put({id,c});}
        function getLocal(id,cb){if(!db)return cb(null);db.transaction(["media"],"readonly").objectStore("media").get(id).onsuccess=e=>cb(e.target.result?e.target.result.c:null);}

        let currentBot=null, allChats=[], activeTab='chats', activeChatID=null;
        let pollInterval = null;

        window.onload=()=>{ loadSessions(); }

        function loadSessions() {
            fetch('/api/sessions').then(r=>r.json()).then(res=>{
                const box=document.getElementById('session-list'); box.innerHTML='';
                res.forEach(num=>{
                    box.innerHTML+=`<div class="session-card" onclick="startApp('${num}')">
                    <div style="background:#00a884;color:white;width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;">üì±</div>
                    <div style="font-weight:bold;color:white;">${num}</div></div>`;
                });
            });
        }

        function startApp(id){ currentBot=id; document.getElementById('home-view').style.display='none'; document.getElementById('app-view').style.display='block'; loadChats(); }

        async function loadChats(){
            const res=await fetch(`/api/chats?bot_id=${currentBot}`);
            allChats=await res.json();
            renderList();
        }

        function renderList(){
            const list=document.getElementById('chat-list-box'); list.innerHTML='';
            const filtered=allChats.filter(c=>{
                if(activeTab==='groups')return c.type==='group';
                return c.type==='user';
            });
            filtered.forEach(c=>{
                const aid=`av_${c.id.replace(/[^a-zA-Z0-9]/g,'')}`;
                list.innerHTML+=`<div class="chat-item" onclick="openChat('${c.id}','${c.name}','${aid}')">
                <img id="${aid}" class="avatar" src="https://ui-avatars.com/api/?name=${c.name}&background=random">
                <div style="flex:1;overflow:hidden;"><div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
                <div style="font-size:13px;color:#8696a0;">${c.id}</div></div></div>`;
                fetch(`/api/avatar?bot_id=${currentBot}&chat_id=${c.id}`).then(r=>r.json()).then(d=>{if(d.url)document.getElementById(aid).src=d.url;}).catch(()=>{});
            });
        }

        function switchTab(t){ activeTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); renderList(); }

        // --- CHAT LOGIC ---
        let knownMessageIDs = new Set();

        async function openChat(cid,name,aid){
            activeChatID = cid;
            document.getElementById('header-name').innerText=name;
            const src=document.getElementById(aid)?document.getElementById(aid).src:`https://ui-avatars.com/api/?name=${name}`;
            document.getElementById('header-avatar').src=src;
            
            const win=document.getElementById('chat-window'); win.style.transform='translateX(0)';
            const box=document.getElementById('msg-box'); 
            box.innerHTML='<div style="text-align:center;padding:50px;">Loading...</div>';
            
            knownMessageIDs.clear();
            loadMessages(cid, box, true);

            // ‚ö° Start Polling (5 Seconds)
            if(pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => loadMessages(cid, box, false), 5000);
        }

        async function loadMessages(cid, box, isFirstLoad) {
            if(activeChatID !== cid) return; // Safety check

            const res=await fetch(`/api/messages?bot_id=${currentBot}&chat_id=${cid}`);
            const msgs=await res.json();

            if(isFirstLoad) box.innerHTML='';

            msgs.forEach(m=>{
                if(knownMessageIDs.has(m.message_id)) return; // Skip existing
                knownMessageIDs.add(m.message_id);

                let c='';
                const t=m.is_from_me?'sent':'rec';
                const typeClass = m.is_sticker ? 'msg sticker' : `msg ${t}`;
                const time=new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const nameTag=(!m.is_from_me && m.is_group)?`<span class="sender-name">${m.sender_name}</span>`:'';

                // Reply Block
                let replyHtml = '';
                if(m.quoted_msg) {
                    replyHtml = `
                    <div class="reply-box">
                        <div class="reply-sender">${m.quoted_sender || 'Unknown'}</div>
                        <div class="reply-text">${m.quoted_msg}</div>
                    </div>`;
                }

                // Content Logic
                if(m.is_sticker) {
                    c = renderImage(m, true);
                } else if(m.type==='text') {
                    c=m.content;
                } else if(m.type==='image') {
                    c=renderImage(m, false);
                } else if(m.type==='audio') {
                    c=renderAudio(m);
                } else if(m.type==='video') {
                    c=`<video src="${m.content}" style="width:100%;border-radius:6px;" controls></video>`;
                } else {
                    c=`<a href="${m.content}" target="_blank" style="color:#00a884;">üìÑ Attachment</a>`;
                }

                const div = document.createElement('div');
                div.className = typeClass;
                // Stickers don't have bubbles/replies usually shown this way
                if(m.is_sticker) {
                    div.innerHTML = c + `<span class="time" style="text-shadow: 1px 1px 2px black;">${time}</span>`;
                } else {
                    div.innerHTML = `${replyHtml} ${nameTag} ${c} <span class="time">${time}</span>`;
                }
                box.appendChild(div);
            });

            if(isFirstLoad) {
                // Add Secure Footer at the end
                const footer = document.createElement('div');
                footer.className = "secure-footer";
                footer.innerHTML = "üîí End-to-end Encrypted";
                box.appendChild(footer);
                box.scrollTop=box.scrollHeight;
            } else if(msgs.length > knownMessageIDs.size) {
                 // Move footer to bottom if new messages
                 // (Simplified: just auto scroll for now)
                 box.scrollTop=box.scrollHeight;
            }
        }

        function closeChat(){ 
            document.getElementById('chat-window').style.transform='translateX(100%)'; 
            if(pollInterval) clearInterval(pollInterval);
            activeChatID = null;
        }

        // --- MEDIA ---
        function renderImage(m, isSticker) {
            const uid=m.message_id;
            const className = isSticker ? "sticker-img" : "chat-img";
            
            if(m.content==='MEDIA_WAITING'){
                setTimeout(()=>{
                    getLocal(uid, (data)=>{
                        if(data) document.getElementById(`img-${uid}`).src = data;
                        else downloadMedia(uid, `img-${uid}`);
                    });
                },0);
                return `<img id="img-${uid}" class="${className}" src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" onclick="showLightbox(this.src)">`;
            }
            return `<img src="${m.content}" class="${className}" onclick="showLightbox(this.src)">`;
        }

        function renderAudio(m) {
            const uid = m.message_id;
            if(m.content==='MEDIA_WAITING'){
                setTimeout(()=>{
                    getLocal(uid, (data)=>{
                        if(data) setupAudio(uid, data);
                    });
                },0);
                return `
                <div id="player-${uid}" class="wa-audio-player">
                    <div class="control-btn" onclick="downloadAudio('${uid}', this)">
                        <span class="icon dl show">‚¨á</span>
                        <span class="icon play">‚ñ∂</span>
                        <div class="spinner"></div>
                    </div>
                    <div class="audio-info"><div class="progress-bar"></div></div>
                    <audio id="audio-${uid}"></audio>
                </div>`;
            }
            return `<div class="wa-audio-player"><audio src="${m.content}" controls style="height:35px; width:100%; filter:invert(0.9);"></audio></div>`;
        }

        async function downloadMedia(uid, imgID) {
            try { const r=await fetch(`/api/media?msg_id=${uid}`); const d=await r.json(); 
            if(d.content){ saveLocal(uid,d.content); document.getElementById(imgID).src=d.content; } } catch(e){}
        }

        async function downloadAudio(uid, btn) {
            const audio = document.getElementById(`audio-${uid}`);
            const dl = btn.querySelector('.dl');
            const play = btn.querySelector('.play');
            const spin = btn.querySelector('.spinner');

            if(!audio.src) {
                dl.classList.remove('show'); spin.classList.add('show');
                const r=await fetch(`/api/media?msg_id=${uid}`);
                const d=await r.json();
                if(d.content){
                    saveLocal(uid,d.content);
                    audio.src=d.content;
                    spin.classList.remove('show');
                    play.classList.add('show');
                }
            } else {
                audio.paused ? audio.play() : audio.pause();
            }
        }

        function setupAudio(uid, src) {
            const p = document.getElementById(`player-${uid}`);
            if(p) {
                p.innerHTML = `<audio src="${src}" controls style="height:35px; width:100%; filter:invert(0.9);"></audio>`;
            }
        }

        function showLightbox(src){ document.getElementById('lb-img').src=src; document.getElementById('lightbox').style.display='flex'; }

    </script>
</body>
</html>